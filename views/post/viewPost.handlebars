<main role="main" class="container">
  <div class="row pt-2">
    <div class="col-md-8 blog-main">

      {{#if message}}
      <p>{{message}}</p>
      {{else}}
      <div class="blog-post">
        <h2 class="blog-post-title">{{postTitle}}</h2>
        <img class="mt-2 mb-2" src="{{postImage}}" style="width: 100%;">
        <p class="blog-post-meta">{{#formatDate createdAt}} {{/formatDate}} by <a
            href="/profile/{{postAuthorUsername}}">{{postAuthorName}}</a></p>

        {{{postBody}}}

        <p class="float-right">
          <span id="thumbsUp" class="mr-2 pointer" data-toggle="tooltip" data-placement="bottom" title="Like post"
            onclick="reactTo(`post`,`like`, `{{postId}}`)">

            <i class="far fa-thumbs-up fa-2x mr-2"></i><small class="likesCount text-success">{{likesCount}}</small>
          </span>
          <span id="thumbsDown" class="pointer" data-toggle="tooltip" data-placement="bottom" title="Dislike post"
            onclick="reactTo(`post`,`dislike`, `{{postId}}`)">
            <i class="far fa-thumbs-down fa-2x mr-2"></i><small
              class="dislikesCount text-danger mr-2">{{dislikesCount}}</small>
          </span>
          <span id="banIcon" class="pointer" data-toggle="tooltip" data-placement="bottom" title="Report post"
            onclick="reactToPost(`report`, `{{postId}}`)">
            <i class="fas fa-ban fa-2x text-danger mr-2"></i>
          </span>
        </p>
      </div><!-- /.blog-post -->
      <h4>Comments</h4>
      <div id="commentSection" class="blog-post">

        {{#unless Comments}}
        <p>No user has commented on this post for now.</p>
        {{/unless}}
        {{#each Comments}}
        <div class="card mb-2">
          <div class="card-body">
            <div class="row">
              <div class="col-2 pr-0">
                <img class="rounded-circle profileThumbnail" src="{{commentByUserProfileImage}}" />
              </div>
              <div class="col-10 pl-0 pt-2">
                <h4 class="mb-0"><a class="text-dark" href="/profile/{{commentByUserId}}">{{commentBy}}</a></h4>
                <h6 class="mb-0">{{#formatDate createdAt}} {{/formatDate}}</h6>
              </div>
            </div>
            <div class="row mt-1">
              <div class="col-12">
                <p class="mb-1">{{commentBody}}</p>
              </div>
            </div>
            <p class="float-left mb-0">
              <span id="commentThumbsUp" class="pointer" data-toggle="tooltip" data-placement="bottom" title="vote up"
                onclick="reactTo(`comment`,`like`, `{{commentId}}`)">
                <i class="far fa-thumbs-up mr-2"></i><small
                  class="commentLikesCount text-success mr-2">{{likesCount}}</small>
              </span>
              <span id="commentThumbsDown" class="pointer" data-toggle="tooltip" data-placement="bottom"
                title="vote down" onclick="reactTo(`comment`,`dislike`, `{{commentId}}`)">
                <i class="far fa-thumbs-down mr-2"></i><small
                  class="commentDislikesCount text-danger mr-2">{{dislikesCount}}</small>
              </span>
            </p>
          </div>
        </div>
        {{/each}}
      </div>

      <div class="blog-post mb-2">
        <div id="newCommentBox" class="d-none">
          <h4>Lets hear from you</h4>
          <form class="form-row" id="newCommentForm">
            <textarea class="ml-1 mr-1 w-100" name="commentBody" id="commentBody" rows="4"></textarea>
            <p class="float-right mt-3 pl-1">
              <button type="button" class="btn btn-sm btn-outline-dark mr-2"
                onclick="postComment(`{{postId}}`)">Comment</button>
              <button type="button" id="hideNewCommentBox" class="btn btn-sm btn-outline-danger">Cancel</button>
            </p>
          </form>
        </div>
        <p class="text-danger d-none commentSignin">You have to be signed in to comment on a post</p>
        <p class="mt-3 d-none commentSignin"><a type="button" href="/signin"
            class="btn btn-outline-dark btn-block">Click here to sign in</a></p>
        <p class="mt-3" id="showNewCommentBox"><button class="btn btn-outline-dark btn-block">Comment on this
            post</button></p>
      </div>


      <div class="blog-post" id="subscribeSection">
        <h4>Subscribe to more posts from {{postAuthorShortName}}</h4>
        <form class="form-inline">
          <label class="sr-only" for="subscriberEmail">Email Address</label>
          <input type="email" class="form-control mb-2 mr-sm-2" name="subscriberEmail" id="subscriberEmail" placeholder="Email address">
          <button type="button" class="btn btn-secondary mb-2" onclick="subcribeToUser(`{{postAuthorUserId}}`)">Subscribe</button>
        </form>
      </div><!-- /.blog-post -->
      {{/if}}
    </div><!-- /.blog-main -->

    <aside class="col-md-4 blog-sidebar">
      <div class="p-4 mb-3 bg-light rounded">
        <h4 class="font-italic">About {{postAuthorShortName}}</h4>
        <p class="mb-0">{{postAuthorAbout}}</p>
        {{#unless following}}
        <input type="button" class="btn btn-secondary followButton mt-2" onclick="followUser(`{{username}}`)"
          value="Follow" />
        {{else}}
        <input type="button" class="btn btn-outline-secondary followButton mt-2" value="Following" />
        {{/unless}}
        {{!-- <input type="button" class="btn btn-secondary followButton mt-2" onclick="followUser(`{{postAuthorUsername}}`)" value="Follow" /> --}}
      </div>

      <div class="p-4">
        <h4 class="font-italic">Archives</h4>
        <ol class="list-unstyled mb-0">
          <li><a href="#">March 2014</a></li>
          <li><a href="#">February 2014</a></li>
          <li><a href="#">January 2014</a></li>
          <li><a href="#">December 2013</a></li>
          <li><a href="#">November 2013</a></li>
          <li><a href="#">October 2013</a></li>
          <li><a href="#">September 2013</a></li>
          <li><a href="#">August 2013</a></li>
          <li><a href="#">July 2013</a></li>
          <li><a href="#">June 2013</a></li>
          <li><a href="#">May 2013</a></li>
          <li><a href="#">April 2013</a></li>
        </ol>
      </div>

      <div class="p-4">
        <h4 class="font-italic">Find {{postAuthorShortName}} elsewhere</h4>
        <p class="mt-2">
          <span class="mr-2"> <a class="text-dark" href="https://www.facebook.com/{{postAuthorFacebook}}"
              target="_blank"><i class="fab fa-facebook fa-2x"></i></a></span>
          <span class="mr-2"> <a class="text-dark" href="https://www.linkedin.com/in/{{postAuthorLinkedIn}}"
              target="_blank"><i class="fab fa-linkedin fa-2x"></i></a></span>
          <span class="mr-2"> <a class="text-dark" href="https://www.twitter.com/{{postAuthorTwitter}}"
              target="_blank"><i class="fab fa-twitter fa-2x"></i></a></span>
          <span class="mr-2"> <a class="text-dark" href="https://www.github.com/{{postAuthorGithub}}" target="_blank"><i
                class="fab fa-github fa-2x"></i></a></span>
        </p>
      </div>

      <div class="p-4">
        <h4 class="font-italic">Follow {{postAuthorShortName}}</h4>
        {{#unless following}}
        <input type="button" class="btn btn-secondary followButton mt-2" onclick="followUser(`{{username}}`)"
          value="Follow" />
        {{else}}
        <input type="button" class="btn btn-outline-secondary followButton mt-2" value="Following" />
        {{/unless}}
        {{!-- <input type="button" class="btn btn-secondary followButton mt-2" onclick="followUser(`{{postAuthorUsername}}`)" value="Follow" /> --}}
        {{!-- <span class="border border-danger rounded p-2 align-bottom followButton" onclick="followUser(`{{username}}`)">Following</span> --}}
      </div>
    </aside><!-- /.blog-sidebar -->

  </div><!-- /.row -->

  <!-- Then put toasts within -->
  <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <img src="..." class="rounded mr-2" alt="...">
      <strong class="mr-auto">Bootstrap</strong>
      <small class="text-muted">just now</small>
      <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="toast-body">
      See? Just like this.
    </div>
  </div>

</main>

<script type="text/javascript">
  $(function () {
    $('[data-toggle="tooltip"]').tooltip();
  });

  function reactTo(reactTo, reaction, reactToId) {
    var reVal = reaction;
    fetch(`/api/react/${reactTo}/${reaction}/${reactToId}`).then(response => response.json())
      .then((data) => {
        if (!data.response) {

          if (reactTo === 'post') {
            $('.likesCount').text(data.likesCount);
            $('.dislikesCount').text(data.dislikesCount);
            $('#thumbsUp').removeClass('text-danger');
            $('#thumbsDown').removeClass('text-danger');
          }

          if (reactTo === 'comment') {
            $('.commentLikesCount').text(data.likesCount);
            $('.commentDislikesCount').text(data.dislikesCount);
            $('#commentThumbsUp').removeClass('text-danger');
            $('#commentThumbsDown').removeClass('text-danger');
          }

        } else {

          if (reactTo === 'post' && reaction === 'like') {
            $('#thumbsUp').addClass('text-danger');
            $('#thumbsDown').removeClass('text-danger');
          }

          if (reactTo === 'post' && reaction === 'dislike') {
            $('#thumbsUp').removeClass('text-danger');
            $('#thumbsDown').addClass('text-danger');
          }

          if (reactTo === 'comment' && reaction === 'like') {
            $('#commentThumbsUp').addClass('text-danger');
            $('#commentThumbsDown').removeClass('text-danger');
          }

          if (reactTo === 'comment' && reaction === 'dislike') {
            $('#commentThumbsUp').removeClass('text-danger');
            $('#commentThumbsDown').addClass('text-danger');
          }

        }
      });
  }

  function followUser(username) {
    fetch(`/api/follow/${username}`).then(response => response.json())
      .then((data) => {
        $('.followButton').attr('onclick', '');
        $('.followButton').text('Following');
        $('.followButton').removeClass('btn-secondary').addClass('btn-outline-secondary');
      }).catch((err) => {
        console.error(err);
      });
  }

  $('#showNewCommentBox').click(() => {
    if (isAuthenticated()) {
      $('#newCommentBox').removeClass('d-none');
      $('#showNewCommentBox').addClass('d-none');
    } else {
      $('.commentSignin').removeClass("d-none");
      $('#showNewCommentBox').addClass("d-none");
    }

  });

  $('#hideNewCommentBox').click(() => {
    $('#newCommentBox').addClass('d-none');
    $('#showNewCommentBox').removeClass('d-none');
  });

  function postComment(postId) {
    fetch(`/api/post/newcomment/${postId}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ commentBody: $('#commentBody').val() }),
      }
    ).then(response => response.json())
      .then((data) => {
        var html = `<div class="card mb-2">
        <div class="card-body">
            <div class="row">
              <div class="col-2 pr-0">
                <img class="rounded-circle profileThumbnail" src="${data.User.profileImage}" />
              </div>
              <div class="col-10 pl-0 pt-2">
                <h4 class="mb-0"><a href="/profile/${data.UserUserId}" class="text-dark">${data.User.name}</a> </h4>
                <h6 class="mb-0">${data.createdAt}</h6>
              </div>
            </div>

            <div class="row mt-1">
              <div class="col-12">
                <p class="mb-1">${data.commentBody}</p>
              </div>
            </div>

            <p class="float-left mb-0">
              <span id="commentThumbsUp" class="pointer" data-toggle="tooltip" data-placement="bottom" title="vote up" onclick="reacTo('comment', 'like', ${data.commentId} )">
                <i class="far fa-thumbs-up mr-2"></i><small class="commentLikesCount text-success mr-2">${data.likesCount}</small>
              </span>
              <span id="commentThumbsDown" class="pointer" data-toggle="tooltip" data-placement="bottom" title="vote down" onclick="reacTo('comment', 'dislike', ${data.commentId} )">
                <i class="far fa-thumbs-down mr-2"></i><small class="commentDislikesCount text-success mr-2">${data.dislikesCount}</small>
              </span>
            </p>

          </div>
        </div>`;

        $('#commentSection').prepend(html);
        $('#newCommentBox').addClass('d-none');
        $('#showNewCommentBox').removeClass('d-none');
      }).catch((err) => {
        console.error(err);
      });
  }

  function subcribeToUser(userId){
    fetch(`/api/subscribe/user/${userId}`, 
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subscriberEmail: $('#subscriberEmail').val() }),
      }
    ).then(response => response.json())
      .then((data) => {
        $('#subscribeSection').html('<h5>' + data.response + '</h5>');
      });
  }

</script>